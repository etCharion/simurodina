<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rodinný rozpočet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }
        .container {
            max-width: 960px;
        }
        .section-title {
            position: sticky;
            top: 0;
            background-color: #e5e7eb;
            z-index: 10;
        }
        .evaluation-section, .details-section, .event-results {
            display: none;
            overflow: hidden;
            transition: all 0.3s ease-in-out;
        }
        .details-section.open, .event-results.open {
            display: block;
        }
        .hidden-item {
            display: none;
        }
        .disabled-button {
            cursor: not-allowed;
            opacity: 0.5;
        }
        .explanation-text {
            display: none;
            font-style: italic;
            color: #4b5563;
            margin-top: 8px;
            font-size: 0.875rem;
        }
        .dropdown-select {
            appearance: none;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>');
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            background-size: 1.2rem;
            padding-right: 2rem;
        }
        .tooltip-container {
            position: relative;
            display: inline-block;
        }
        .tooltip-text {
            visibility: hidden;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px 10px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -150px;
            opacity: 0;
            transition: opacity 0.3s;
            width: 300px;
        }
        .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #333 transparent transparent transparent;
        }
        .tooltip-container:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        .question-icon {
            cursor: pointer;
            margin-left: 5px;
            font-weight: bold;
        }
        .disabled-item {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .disabled-item input, .disabled-item select {
            pointer-events: none;
        }
        @media (min-width: 768px) {
            .income-events-section {
                display: flex;
                gap: 2rem;
            }
            .income-events-section > div {
                flex: 1;
            }
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div class="container mx-auto bg-white p-6 sm:p-8 rounded-2xl shadow-lg border border-gray-200">
        <h1 class="text-3xl sm:text-4xl font-bold text-center mb-6 text-indigo-800">Rodinný rozpočet</h1>

        <!-- Příjmy a náhodné události vedle sebe -->
        <div class="income-events-section mb-8">
            <!-- Příjmy -->
            <div class="mb-8 p-4 bg-gray-100 rounded-xl">
                <h2 class="text-xl sm:text-2xl font-bold mb-4 text-indigo-700">Příjmy</h2>
                <div class="flex flex-col sm:flex-row items-center sm:space-x-4">
                    <div class="mb-4 sm:mb-0 w-full sm:w-auto">
                        <label for="income-select" class="block text-sm font-medium text-gray-700">Vyberte výši příjmu:</label>
                        <select id="income-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm">
                        </select>
                    </div>
                </div>
                <div class="text-lg font-medium text-gray-900 mt-4">
                    <p>Roční příjem: <span id="annual-income-display" class="font-bold text-green-600"></span> Kč</p>
                </div>
            </div>
            
            <!-- Náhodné události -->
            <div class="mb-8 p-4 bg-gray-100 rounded-xl">
                <h2 class="text-xl sm:text-2xl font-bold mb-4 text-indigo-700 cursor-pointer flex justify-between items-center" id="events-toggle">
                    Náhodné události
                    <span class="text-indigo-600 transform transition-transform duration-300">▼</span>
                </h2>
                <div id="events-section" class="details-section">
                    <div class="flex flex-col sm:flex-row items-center sm:space-x-4 mb-4">
                        <div class="mb-4 sm:mb-0 w-full sm:w-auto">
                            <label for="max-events" class="block text-sm font-medium text-gray-700">Max. počet událostí:</label>
                            <select id="max-events" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm">
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                                <option value="6">6</option>
                            </select>
                        </div>
                        <button id="roll-events-button" class="w-full sm:w-auto bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-xl shadow-md transition duration-300 ease-in-out">
                            Vylosovat události
                        </button>
                    </div>
                    <div id="events-list" class="space-y-2 p-4 bg-white rounded-xl border border-gray-200">
                        <!-- Události budou přidány dynamicky -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Výdaje a body -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
            <div class="md:col-span-2">
                <div id="categories-container" class="space-y-6">
                    <!-- Kategorie budou přidány dynamicky -->
                </div>
            </div>
            <div class="md:col-span-1">
                <div class="sticky top-4">
                    <div class="p-6 bg-blue-100 rounded-xl shadow-md border border-blue-200 mb-6">
                        <h2 class="text-2xl font-bold mb-4 text-blue-800 cursor-pointer flex justify-between items-center" id="summary-toggle">
                            Přehled rozpočtu
                            <span class="text-blue-600 transform transition-transform duration-300">▼</span>
                        </h2>
                        <div class="space-y-2">
                            <p class="text-lg font-semibold">Roční výdaje: <span id="annual-expenses" class="font-bold">0</span> Kč</p>
                            <p class="text-lg font-semibold">Zůstatek: <span id="balance" class="font-bold text-green-600">0</span> Kč</p>
                        </div>
                        <div id="details-section" class="details-section mt-4 pt-4 border-t border-blue-200">
                            <h3 class="text-xl font-bold mb-2 text-blue-700">Detailní přehled</h3>
                            <ul class="space-y-1 text-sm">
                                <li>Měsíční příjem: <span id="monthly-income-detail" class="font-bold"></span> Kč</li>
                                <li>Roční příjem: <span id="annual-income-detail" class="font-bold"></span> Kč</li>
                                <li class="pt-2 border-t border-gray-300 mt-2">Celkové měsíční výdaje: <span id="monthly-expenses-detail" class="font-bold"></span> Kč</li>
                                <li>Celkové roční jednorázové výdaje: <span id="one-time-expenses-detail" class="font-bold"></span> Kč</li>
                                <li>Celkové roční výdaje: <span id="total-annual-expenses-detail" class="font-bold"></span> Kč</li>
                                <li class="pt-2 border-t border-gray-300 mt-2">Zůstatek: <span id="balance-detail" class="font-bold"></span> Kč</li>
                            </ul>
                        </div>
                    </div>
                    
                    <button id="evaluate-button" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-xl shadow-md transition duration-300 ease-in-out disabled-button" disabled>
                        Vyhodnotit rozpočet
                    </button>

                    <!-- Sekce pro vyhodnocení -->
                    <div id="evaluation-section" class="evaluation-section mt-6 p-6 bg-purple-100 rounded-xl shadow-md border border-purple-200">
                        <h2 class="text-2xl font-bold mb-4 text-purple-800">Vyhodnocení</h2>
                        <div class="space-y-2">
                            <p class="text-lg font-semibold">Body zodpovědnosti: <span id="responsibility-score" class="font-bold text-gray-800">0</span></p>
                            <p class="text-lg font-semibold">Body komfortu: <span id="comfort-score" class="font-bold text-gray-800">0</span></p>
                            <p class="text-xl font-bold mt-4 text-purple-900">Celkové skóre: <span id="total-score" class="text-2xl font-extrabold">0</span></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Data z pracovních listů
        const budgetData = {
            incomes: [
                { label: '41 000 (23 000 + 18 000) Kč - Nízký příjem', value: 41000, husbandIncome: 23000, wifeIncome: 18000, weight: 25 },
                { label: '61 000 (33 000 + 28 000) Kč - Střední příjem', value: 61000, husbandIncome: 33000, wifeIncome: 28000, weight: 60 },
                { label: '80 000 (45 000 + 35 000) Kč - Vysoký příjem', value: 80000, husbandIncome: 45000, wifeIncome: 35000, weight: 15 }
            ],
            categories: [
                {
                    name: 'Bydlení a energie',
                    selection: 'single',
                    items: [
                        { name: 'Byt 2+1 (nájem)', monthlyCost: 18000, comfort: 5, responsibility: 1 },
                        { name: 'Byt 4+1 (nájem)', monthlyCost: 22000, comfort: 15, responsibility: 3 },
                        { name: 'Dům 5+1 (hypotéka)', monthlyCost: 20000, comfort: 20, responsibility: 10 }
                    ],
                    explanation: 'Výdaje na bydlení se po Smrti ženy sníží o 1/5.'
                },
                {
                    name: 'Potraviny',
                    selection: 'single',
                    items: [
                        { name: 'Bio-strava', monthlyCost: 22000, comfort: 8, responsibility: 10 },
                        { name: 'Zdravá a vyvážená strava', monthlyCost: 15000, comfort: 2, responsibility: 8 },
                        { name: 'Jídlo', monthlyCost: 11000, comfort: 1, responsibility: 1 }
                    ],
                    explanation: 'Výdaje na potraviny se po Smrti ženy sníží o 1/3.'
                },
                {
                    name: 'Škola',
                    selection: 'single',
                    items: [
                        { name: 'Soukromá střední škola pro Sofii', monthlyCost: 3500, comfort: 10, responsibility: 3, person: 'Sofie' },
                        { name: 'Státní střední škola pro Sofii', monthlyCost: 500, comfort: 2, responsibility: 1, person: 'Sofie' },
                        { name: 'Sofie jde pracovat', monthlyCost: -16000, comfort: -5, responsibility: -20, person: 'Sofie' }
                    ]
                },
                {
                    name: 'Multimédia',
                    selection: 'multiple',
                    items: [
                        { name: 'Mobilní telefon dospělí', monthlyCost: 400, comfort: 3, responsibility: 0, personSelect: true, personCount: 2, affectedByDeath: true },
                        { name: 'Mobilní telefon Sofie', monthlyCost: 300, comfort: 2, responsibility: 0, person: 'Sofie' },
                        { name: 'Mobilní telefon Milouše', monthlyCost: 200, comfort: 2, responsibility: 0, person: 'Milouš' },
                        { name: 'Internet Start (30 mb/s)', monthlyCost: 400, comfort: 5, responsibility: 0 },
                        { name: 'Internet Fun (1000 mb/s)', monthlyCost: 700, comfort: 6, responsibility: 0 },
                        { name: 'Televize', monthlyCost: 135, comfort: 2, responsibility: 0 },
                        { name: 'Televize + Netflix', monthlyCost: 500, comfort: 3, responsibility: 0 },
                        { name: 'Televize + Netflix + Herní konzole', monthlyCost: 1500, comfort: 7, responsibility: 0 }
                    ]
                },
                {
                    name: 'Doprava',
                    selection: 'single',
                    items: [
                        { name: 'Osobní automobil', monthlyCost: 6000, comfort: 6, responsibility: 8 },
                        { name: 'Osobní automobil a děti autobusem', monthlyCost: 4000, comfort: 4, responsibility: 6 },
                        { name: 'Hromadná doprava', monthlyCost: 3000, comfort: 2, responsibility: 1 },
                        { name: 'Hromadná doprava + Jízdní kolo', monthlyCost: 1000, comfort: 1, responsibility: 4 }
                    ]
                },
                {
                    name: 'Volný čas',
                    selection: 'multiple',
                    items: [
                        { name: 'Občasná návštěva kina, divadla, atd.', monthlyCost: 1500, comfort: 5, responsibility: 0 },
                        { name: 'Kroužek malování pro Sofii', monthlyCost: 500, comfort: 3, responsibility: 5, person: 'Sofie' },
                        { name: 'Kroužek programování pro Milouše', monthlyCost: 700, comfort: 3, responsibility: 8, person: 'Milouš' },
                        { name: 'Výuka hry na klavír pro Evu', monthlyCost: 1000, comfort: 3, responsibility: 0, person: 'Eva' },
                        { name: 'Hokej pro Adama', monthlyCost: 1000, comfort: 3, responsibility: 0, person: 'Adam' },
                        { name: 'Kouření (za 1 Os., 10c. denně)', monthlyCost: 2000, comfort: 2, responsibility: -2, personSelect: true, personCount: 2, affectedByDeath: true },
                        { name: 'Alkohol (za 1 Os., 1 Pivo denně)', monthlyCost: 800, comfort: 2, responsibility: -5, personSelect: true, personCount: 2, affectedByDeath: true }
                    ]
                },
                {
                    name: 'Domácí mazlíčci',
                    selection: 'multiple',
                    items: [
                        { name: 'Velký pes pro Evu', monthlyCost: 1200, comfort: 5, responsibility: 0, person: 'Eva' },
                        { name: 'Papoušek pro Milouše', monthlyCost: 400, comfort: 3, responsibility: 0, person: 'Milouš' },
                        { name: 'Králík pro Sofii', monthlyCost: 200, comfort: 2, responsibility: 0, person: 'Sofie' }
                    ]
                },
                {
                    name: 'Dovolená',
                    selection: 'multiple',
                    items: [
                        { name: 'Místní dovolená (Camp, Tatry, Chata)', oneTimeCost: 16000, comfort: 5, responsibility: 0 },
                        { name: 'Dovolená Chorvatsko', oneTimeCost: 30000, comfort: 10, responsibility: 0 },
                        { name: 'Last minute – Chorvatsko', oneTimeCost: 25000, comfort: 10, responsibility: 0 },
                        { name: 'Itálie', oneTimeCost: 50000, comfort: 15, responsibility: 0 },
                        { name: 'Malé divy', oneTimeCost: 90000, comfort: 20, responsibility: 0 },
                        { name: 'English camp za 1. dítě', oneTimeCost: 4500, comfort: 4, responsibility: 6, personSelect: true, personCount: 2 },
                        { name: 'Tábor za 1 dítě', oneTimeCost: 3000, comfort: 2, responsibility: 3, personSelect: true, personCount: 2 }
                    ]
                },
                {
                    name: 'Dárky a předměty koupě',
                    selection: 'multiple',
                    items: [
                        { name: 'Dárky (vánoce a narozeniny) a oslava', oneTimeCost: 8000, comfort: 4, responsibility: 0 },
                        { name: 'Dražší dárky, oslava', oneTimeCost: 16000, comfort: 7, responsibility: 0 },
                        { name: 'Drahé dárky, oslava', oneTimeCost: 22000, comfort: 10, responsibility: 0 },
                        { name: 'Nové herní PC (Milouš)', oneTimeCost: 20000, comfort: 3, responsibility: 0, person: 'Milouš' },
                        { name: 'Nový notebook (Sofie)', oneTimeCost: 15000, comfort: 4, responsibility: 0, person: 'Sofie' },
                        { name: 'Skateboard (Milouš)', oneTimeCost: 3000, comfort: 2, responsibility: 0, person: 'Milouš' },
                        { name: 'Snowboard (Sofie)', oneTimeCost: 8000, comfort: 2, responsibility: 0, person: 'Sofie' },
                        { name: 'Nový mobilní telefon (za Os.)', oneTimeCost: 10000, comfort: 2, responsibility: 0, personSelect: true, personCount: 2 },
                        { name: 'Nová skříň', oneTimeCost: 10000, comfort: 3, responsibility: 0 }
                    ]
                },
                {
                    name: 'Oblečení, boty, kosmetika atd.',
                    selection: 'single',
                    items: [
                        { name: 'Kvalitní nebo značkové oblečení', monthlyCost: 10000, comfort: 7, responsibility: 4 },
                        { name: 'Obyčejné oblečení', monthlyCost: 5000, comfort: 5, responsibility: 3 },
                        { name: 'Oblečení kupované na tržnici', monthlyCost: 2000, comfort: 4, responsibility: 1 }
                    ],
                    explanation: 'Výdaje na oblečení se po Smrti ženy sníží o 1/4.'
                },
                {
                    name: 'Volné finance',
                    selection: 'multiple',
                    items: [
                        { name: 'Užít si volné peníze', oneTimeCost: 0, comfort: 0, responsibility: 0, type: 'enjoy', explanation: 'Za každých investovaných 6 000 Kč jste získali 1 bod komfortu.' },
                        { name: 'Šetřit si volné peníze', oneTimeCost: 0, comfort: 0, responsibility: 0, type: 'save', explanation: 'Za každých ušetřených 4 000 Kč jste získali 1 bod zodpovědnosti.' }
                    ]
                }
            ],
            randomEvents: [
                { name: 'Nemoc muže', monthlyCost: 'auto', comfort: -5, responsibility: 0, type: 'illness', weight: 6, explanation: 'Příjem muže se sníží o 50 %, což se projeví na celkovém ročním rozpočtu.' },
                { name: 'Smrt ženy', monthlyCost: 'auto', comfort: -2, responsibility: -3, type: 'death', weight: 6, explanation: 'Rodina přijde o příjem ženy a sníží se výdaje na bydlení o 1/5, jídlo o 1/3 a oblečení o 1/4.' },
                { name: 'Narození dítěte', monthlyCost: 5000, comfort: 10, responsibility: 10, weight: 3 },
                { name: 'Malý dluh', monthlyCost: 2000, comfort: -3, responsibility: -5, weight: 6 },
                { name: 'Střední dluh', monthlyCost: 5000, comfort: -5, responsibility: -8, weight: 3 },
                { name: 'Velký dluh', monthlyCost: 10000, comfort: -10, responsibility: -15, weight: 1 }
            ]
        };

        const incomeSelect = document.getElementById('income-select');
        const annualIncomeDisplay = document.getElementById('annual-income-display');
        const annualExpensesDisplay = document.getElementById('annual-expenses');
        const balanceDisplay = document.getElementById('balance');
        const categoriesContainer = document.getElementById('categories-container');
        const evaluateButton = document.getElementById('evaluate-button');
        const evaluationSection = document.getElementById('evaluation-section');
        const responsibilityScoreDisplay = document.getElementById('responsibility-score');
        const comfortScoreDisplay = document.getElementById('comfort-score');
        const totalScoreDisplay = document.getElementById('total-score');
        const summaryToggle = document.getElementById('summary-toggle');
        const detailsSection = document.getElementById('details-section');
        const monthlyIncomeDetail = document.getElementById('monthly-income-detail');
        const annualIncomeDetail = document.getElementById('annual-income-detail');
        const monthlyExpensesDetail = document.getElementById('monthly-expenses-detail');
        const oneTimeExpensesDetail = document.getElementById('one-time-expenses-detail');
        const totalAnnualExpensesDetail = document.getElementById('total-annual-expenses-detail');
        const balanceDetail = document.getElementById('balance-detail');
        const eventsToggle = document.getElementById('events-toggle');
        const eventsSection = document.getElementById('events-section');
        const maxEventsSelect = document.getElementById('max-events');
        const rollEventsButton = document.getElementById('roll-events-button');
        const eventsList = document.getElementById('events-list');

        let selectedItems = {};
        let initialMonthlyIncome = 0;
        let currentMonthlyIncome = 0;
        
        // Načte příjmy do selectu a vybere jeden na základě pravděpodobnosti
        function loadIncomes() {
            incomeSelect.innerHTML = budgetData.incomes.map(income => 
                `<option value="${income.value}" data-husband="${income.husbandIncome}" data-wife="${income.wifeIncome}">${income.label}</option>`
            ).join('');

            rollIncome();
        }

        function rollIncome() {
            const totalWeight = budgetData.incomes.reduce((sum, i) => sum + i.weight, 0);
            let roll = Math.random() * totalWeight;
            let currentWeight = 0;
            let selectedIndex = 0;

            for (let i = 0; i < budgetData.incomes.length; i++) {
                currentWeight += budgetData.incomes[i].weight;
                if (roll <= currentWeight) {
                    selectedIndex = i;
                    break;
                }
            }

            incomeSelect.options[selectedIndex].selected = true;
            initialMonthlyIncome = parseFloat(incomeSelect.options[selectedIndex].value);
            currentMonthlyIncome = initialMonthlyIncome;
            annualIncomeDisplay.textContent = (currentMonthlyIncome * 12).toLocaleString('cs-CZ');
        }

        // Vykreslí kategorie a položky
        function renderCategories() {
            categoriesContainer.innerHTML = '';
            budgetData.categories.forEach((category, catIndex) => {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'p-4 bg-gray-50 rounded-xl border border-gray-200';
                categoryDiv.innerHTML = `<h2 class="text-xl font-bold mb-3 section-title">${category.name}</h2>`;

                const itemsContainer = document.createElement('div');
                itemsContainer.className = 'space-y-2';
                category.items.forEach((item, itemIndex) => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'p-3 bg-white rounded-lg shadow-sm flex items-center justify-between transition-colors duration-200';
                    
                    let inputElement;
                    if (category.selection === 'single') {
                        inputElement = `<input type="radio" name="category-${catIndex}" value="${itemIndex}" class="form-radio text-indigo-600 focus:ring-indigo-500 rounded-full">`;
                    } else if (category.selection === 'multiple') {
                        inputElement = `<input type="checkbox" name="category-${catIndex}" value="${itemIndex}" class="form-checkbox text-indigo-600 focus:ring-indigo-500 rounded-md">`;
                    }

                    let costDisplay = '';
                    let specialInput = '';
                    let pointsDisplay = ''; 
                    let fixedPointsDisplay = '';
                    let personSelect = '';
                    let personMax = 2; // Default pro počet osob

                    if (item.personSelect) {
                        if (item.personCount) {
                            personMax = item.personCount;
                        }
                        let options = '';
                        for(let i = 1; i <= personMax; i++) {
                            options += `<option value="${i}">${i} Os.</option>`;
                        }
                        personSelect = `
                            <select class="person-select text-gray-600 ml-2 border rounded-md p-1 bg-white dropdown-select" data-original-count="${personMax}">
                                ${options}
                            </select>
                        `;
                    }

                    if (category.name === 'Volné finance') {
                         specialInput = `<input type="number" id="${item.type}-amount" placeholder="Zadejte částku..." class="w-32 ml-4 p-1 text-sm border-gray-300 rounded-md shadow-sm">`;
                         costDisplay = `Kč/rok`;
                         pointsDisplay = `<span id="${item.type}-points" class="hidden-item text-gray-400 ml-2"></span>`;
                    } else {
                         if (item.monthlyCost !== undefined) {
                            costDisplay = `${item.monthlyCost.toLocaleString('cs-CZ')} Kč/měs`;
                         } else if (item.oneTimeCost !== undefined) {
                            costDisplay = `${item.oneTimeCost.toLocaleString('cs-CZ')} Kč/rok`;
                         }
                         fixedPointsDisplay = `
                            <span class="comfort-score hidden-item text-gray-400 ml-4">K: ${item.comfort}</span>
                            <span class="responsibility-score hidden-item text-gray-400 ml-2">Z: ${item.responsibility}</span>
                         `;
                    }

                    itemDiv.innerHTML = `
                        <label class="flex items-center space-x-3 w-full">
                            ${inputElement}
                            <span class="text-gray-800">${item.name}</span>
                        </label>
                        <div class="flex items-center justify-end">
                            ${personSelect}
                            ${specialInput}
                            <span class="text-gray-600 ml-4">${costDisplay}</span>
                            ${fixedPointsDisplay}
                            ${pointsDisplay}
                        </div>
                    `;
                    if (item.explanation) {
                         itemDiv.innerHTML += `<div class="explanation-text ml-8">${item.explanation}</div>`;
                    }
                    if (item.person) {
                        itemDiv.dataset.person = item.person;
                    }
                    if (item.affectedByDeath) {
                        itemDiv.dataset.affectedbydeath = 'true';
                    }
                    itemsContainer.appendChild(itemDiv);
                });
                categoryDiv.appendChild(itemsContainer);
                categoriesContainer.appendChild(categoryDiv);
            });
        }
        
        // Vykreslí náhodné události s checkboxem
        function renderRandomEvents() {
            eventsList.innerHTML = '';
            budgetData.randomEvents.forEach((event, eventIndex) => {
                const eventDiv = document.createElement('div');
                eventDiv.className = 'p-3 bg-white rounded-lg shadow-sm flex items-center justify-between transition-colors duration-200';
                
                let costText = '';
                if (event.monthlyCost !== undefined) {
                    costText = `${event.monthlyCost !== 'auto' ? event.monthlyCost.toLocaleString('cs-CZ') : '?' } Kč/měs`;
                } else if (event.oneTimeCost !== undefined) {
                    costText = `${event.oneTimeCost.toLocaleString('cs-CZ')} Kč/rok`;
                }

                let tooltip = '';
                if (event.explanation) {
                    tooltip = `
                        <div class="tooltip-container">
                            <span class="question-icon text-gray-500 hover:text-gray-700">?</span>
                            <span class="tooltip-text">${event.explanation}</span>
                        </div>
                    `;
                }

                eventDiv.innerHTML = `
                    <label class="flex items-center space-x-3 w-full">
                        <input type="checkbox" name="random-event" value="${eventIndex}" class="form-checkbox text-indigo-600 focus:ring-indigo-500 rounded-md">
                        <span class="text-gray-800">${event.name}</span>
                        ${tooltip}
                    </label>
                    <div class="flex items-center justify-end">
                        <span class="text-gray-600 ml-4" id="event-cost-${eventIndex}">${costText}</span>
                        <span class="text-gray-400 ml-4">K: ${event.comfort} Z: ${event.responsibility}</span>
                    </div>
                `;
                eventsList.appendChild(eventDiv);
            });
        }

        // Zkontroluje, zda jsou vyplněny všechny povinné kategorie
        function checkFormValidity() {
            let allSingleSelected = true;
            budgetData.categories.forEach((category, catIndex) => {
                if (category.selection === 'single') {
                    const isSelected = document.querySelector(`input[name="category-${catIndex}"]:checked`);
                    if (!isSelected) {
                        allSingleSelected = false;
                    }
                }
            });

            if (allSingleSelected) {
                evaluateButton.disabled = false;
                evaluateButton.classList.remove('disabled-button');
                evaluateButton.classList.add('hover:bg-indigo-700');
            } else {
                evaluateButton.disabled = true;
                evaluateButton.classList.add('disabled-button');
                evaluateButton.classList.remove('hover:bg-indigo-700');
            }
        }
        
        // Funkce pro losování událostí
        function rollEvents() {
            // Zruší zatržení všech událostí
            document.querySelectorAll('input[name="random-event"]').forEach(checkbox => checkbox.checked = false);

            const maxEvents = parseInt(maxEventsSelect.value, 10);
            const events = budgetData.randomEvents;
            const rolledEventIndices = [];
            const totalWeight = events.reduce((sum, e) => sum + e.weight, 0);

            // Vylosování první události (garantováno)
            let roll = Math.random() * totalWeight;
            let currentWeight = 0;
            for (let i = 0; i < events.length; i++) {
                currentWeight += events[i].weight;
                if (roll <= currentWeight) {
                    rolledEventIndices.push(i);
                    break;
                }
            }

            // Losování dalších událostí s klesající pravděpodobností
            for (let i = 1; i < maxEvents; i++) {
                if (Math.random() < (1 / (i + 1))) { // Klesající pravděpodobnost
                    roll = Math.random() * totalWeight;
                    currentWeight = 0;
                    for (let j = 0; j < events.length; j++) {
                        currentWeight += events[j].weight;
                        if (roll <= currentWeight && !rolledEventIndices.includes(j)) {
                            rolledEventIndices.push(j);
                            break;
                        }
                    }
                }
            }
            
            // Zatržení vylosovaných událostí
            rolledEventIndices.forEach(index => {
                document.querySelector(`input[name="random-event"][value="${index}"]`).checked = true;
            });

            calculateBudget();
        }

        // Funkce pro aktualizaci stavu prvků na základě události "Smrt ženy"
        function updateUIForDeathEvent(isDeathEventSelected) {
            const allItems = document.querySelectorAll('#categories-container > div > div > div');
            
            allItems.forEach(itemDiv => {
                const person = itemDiv.dataset.person;
                if (person && person.includes('Eva')) {
                    const input = itemDiv.querySelector('input');
                    if (isDeathEventSelected) {
                        itemDiv.classList.add('disabled-item');
                        if (input) {
                            input.checked = false;
                        }
                    } else {
                        itemDiv.classList.remove('disabled-item');
                    }
                }
            });

            // Aktualizace výběru osob u položek s personSelect=true
            const personSelectItems = document.querySelectorAll('#categories-container .person-select');
            personSelectItems.forEach(select => {
                const itemDiv = select.closest('.flex.items-center.justify-between');
                const isAffected = itemDiv.dataset.affectedbydeath === 'true';

                if (isAffected) {
                    const originalCount = parseInt(select.dataset.originalCount, 10);
                    const originalValue = select.value;

                    if (isDeathEventSelected && originalCount === 2) {
                         select.innerHTML = `<option value="1">1 Os.</option>`;
                         select.value = 1;
                    } else if (!isDeathEventSelected && originalCount === 2) {
                         select.innerHTML = `<option value="1">1 Os.</option><option value="2">2 Os.</option>`;
                         select.value = originalValue;
                    }
                }
            });
        }

        // Výpočet rozpočtu
        function calculateBudget() {
            let totalMonthlyCost = 0;
            let totalOneTimeCost = 0;
            let totalComfort = 0;
            let totalResponsibility = 0;
            let tempMonthlyCost = 0;
            let tempOneTimeCost = 0;

            selectedItems = {};
            currentMonthlyIncome = initialMonthlyIncome;
            let hasDeathEvent = false;

            const selectedIncomeOption = incomeSelect.options[incomeSelect.selectedIndex];
            const husbandIncome = parseFloat(selectedIncomeOption.dataset.husband);
            const wifeIncome = parseFloat(selectedIncomeOption.dataset.wife);

            // Zjištění, zda je vybrána Smrt ženy
            const selectedEvents = Array.from(document.querySelectorAll('input[name="random-event"]:checked')).map(checkbox => {
                const eventIndex = parseInt(checkbox.value, 10);
                return budgetData.randomEvents[eventIndex];
            });
            hasDeathEvent = selectedEvents.some(event => event.type === 'death');
            updateUIForDeathEvent(hasDeathEvent);

            // Výpočet z kategorií
            budgetData.categories.forEach((category, catIndex) => {
                const categoryInputs = document.querySelectorAll(`input[name="category-${catIndex}"]:checked`);
                selectedItems[catIndex] = [];

                categoryInputs.forEach(input => {
                    const itemIndex = parseInt(input.value, 10);
                    const item = category.items[itemIndex];

                    const itemDiv = input.closest('.flex.items-center.justify-between');
                    if (itemDiv && itemDiv.classList.contains('disabled-item')) {
                        return;
                    }

                    selectedItems[catIndex].push(item);
                    
                    let multiplier = 1;
                    if (item.personSelect) {
                        const personSelect = input.closest('.flex.items-center.justify-between').querySelector('.person-select');
                        multiplier = parseInt(personSelect.value, 10);
                    }

                    if (category.name === 'Volné finance') {
                        const amountInput = document.getElementById(`${item.type}-amount`);
                        const amount = parseFloat(amountInput.value);
                        let calculatedComfort = 0;
                        let calculatedResponsibility = 0;

                        if (!isNaN(amount) && amount > 0) {
                            if (item.type === 'enjoy') {
                                calculatedComfort = Math.floor(amount / 6000);
                                totalComfort += calculatedComfort;
                                tempOneTimeCost += amount;
                            } else if (item.type === 'save') {
                                calculatedResponsibility = Math.floor(amount / 4000);
                                totalResponsibility += calculatedResponsibility;
                                tempOneTimeCost += amount;
                            }
                        }
                        // Aktualizace zobrazení bodů
                        const pointsDisplay = document.getElementById(`${item.type}-points`);
                        if (pointsDisplay) {
                            pointsDisplay.textContent = `K: ${calculatedComfort} Z: ${calculatedResponsibility}`;
                        }

                    } else {
                        if (item.monthlyCost !== undefined) {
                            tempMonthlyCost += item.monthlyCost * multiplier;
                        }
                        if (item.oneTimeCost !== undefined) {
                            tempOneTimeCost += item.oneTimeCost * multiplier;
                        }
                        totalComfort += item.comfort * multiplier;
                        totalResponsibility += item.responsibility * multiplier;
                    }
                });
            });

            // Aplikace náhodných událostí
            selectedEvents.forEach(event => {
                const eventIndex = budgetData.randomEvents.findIndex(e => e.name === event.name);
                let cost = 0;
                if (event.type === 'illness') {
                    cost = husbandIncome * 0.5;
                    currentMonthlyIncome -= cost;
                } else if (event.type === 'death') {
                    cost = wifeIncome;
                    currentMonthlyIncome -= cost;
                } else if (event.monthlyCost !== undefined) {
                    cost = event.monthlyCost;
                    totalMonthlyCost += event.monthlyCost;
                } else if (event.oneTimeCost !== undefined) {
                    totalOneTimeCost += event.oneTimeCost;
                }

                if (event.type === 'illness' || event.type === 'death') {
                     const eventCostEl = document.getElementById(`event-cost-${eventIndex}`);
                     if (eventCostEl) {
                        eventCostEl.textContent = `${cost.toLocaleString('cs-CZ')} Kč/měs`;
                     }
                }
                
                totalComfort += event.comfort;
                totalResponsibility += event.responsibility;
            });

            // Pokud je vybrána Smrt ženy, upravíme výdaje
            const housingExplanationEl = document.querySelector(`#categories-container > div:nth-child(1) .explanation-text`);
            const foodExplanationEl = document.querySelector(`#categories-container > div:nth-child(2) .explanation-text`);
            const clothingExplanationEl = document.querySelector(`#categories-container > div:nth-child(10) .explanation-text`);

            if (hasDeathEvent) {
                const housingItems = selectedItems[0];
                if (housingItems && housingItems.length > 0) {
                    const originalCost = housingItems[0].monthlyCost;
                    const reducedCost = originalCost * (1/5);
                    totalMonthlyCost -= reducedCost;
                    if (housingExplanationEl) {
                        housingExplanationEl.style.display = 'block';
                        housingExplanationEl.textContent = `Výdaje sníženy o ${Math.round(reducedCost).toLocaleString('cs-CZ')} Kč (-1/5).`;
                    }
                }
                const foodItems = selectedItems[1];
                if (foodItems && foodItems.length > 0) {
                    const originalCost = foodItems[0].monthlyCost;
                    const reducedCost = originalCost * (1/3);
                    totalMonthlyCost -= reducedCost;
                    if (foodExplanationEl) {
                        foodExplanationEl.style.display = 'block';
                        foodExplanationEl.textContent = `Výdaje sníženy o ${Math.round(reducedCost).toLocaleString('cs-CZ')} Kč (-1/3).`;
                    }
                }
                const clothingItems = selectedItems[9];
                if (clothingItems && clothingItems.length > 0) {
                    const originalCost = clothingItems[0].monthlyCost;
                    const reducedCost = originalCost * (1/4);
                    totalMonthlyCost -= reducedCost;
                    if (clothingExplanationEl) {
                        clothingExplanationEl.style.display = 'block';
                        clothingExplanationEl.textContent = `Výdaje sníženy o ${Math.round(reducedCost).toLocaleString('cs-CZ')} Kč (-1/4).`;
                    }
                }
            } else {
                // Skrytí vysvětlení, pokud událost není vybrána
                if (housingExplanationEl) housingExplanationEl.style.display = 'none';
                if (foodExplanationEl) foodExplanationEl.style.display = 'none';
                if (clothingExplanationEl) clothingExplanationEl.style.display = 'none';
            }
            
            totalMonthlyCost += tempMonthlyCost;
            totalOneTimeCost += tempOneTimeCost;

            const totalAnnualIncome = currentMonthlyIncome * 12;
            const totalAnnualCost = (totalMonthlyCost * 12) + totalOneTimeCost;
            const balance = totalAnnualIncome - totalAnnualCost;

            annualIncomeDisplay.textContent = Math.round(totalAnnualIncome).toLocaleString('cs-CZ');
            annualExpensesDisplay.textContent = Math.round(totalAnnualCost).toLocaleString('cs-CZ');
            balanceDisplay.textContent = Math.round(balance).toLocaleString('cs-CZ');
            balanceDisplay.classList.remove('text-green-600', 'text-red-600');
            balanceDisplay.classList.add(balance >= 0 ? 'text-green-600' : 'text-red-600');

            responsibilityScoreDisplay.textContent = Math.round(totalResponsibility);
            comfortScoreDisplay.textContent = Math.round(totalComfort);
            
            let totalScore;
            if (totalResponsibility <= 0) {
                totalScore = totalComfort;
            } else {
                totalScore = Math.max(0, totalComfort * totalResponsibility);
            }

            totalScoreDisplay.textContent = Math.round(totalScore).toLocaleString('cs-CZ');

            // Aktualizace detailního přehledu
            monthlyIncomeDetail.textContent = Math.round(currentMonthlyIncome).toLocaleString('cs-CZ');
            annualIncomeDetail.textContent = Math.round(totalAnnualIncome).toLocaleString('cs-CZ');
            monthlyExpensesDetail.textContent = Math.round(totalMonthlyCost).toLocaleString('cs-CZ');
            oneTimeExpensesDetail.textContent = Math.round(totalOneTimeCost).toLocaleString('cs-CZ');
            totalAnnualExpensesDetail.textContent = Math.round(totalAnnualCost).toLocaleString('cs-CZ');
            balanceDetail.textContent = Math.round(balance).toLocaleString('cs-CZ');
            balanceDetail.classList.remove('text-green-600', 'text-red-600');
            balanceDetail.classList.add(balance >= 0 ? 'text-green-600' : 'text-red-600');
        }

        // Event Listeners
        incomeSelect.addEventListener('change', (e) => {
            const selectedOption = e.target.options[e.target.selectedIndex];
            initialMonthlyIncome = parseFloat(selectedOption.value);
            calculateBudget();
            checkFormValidity();
        });

        categoriesContainer.addEventListener('change', (e) => {
            if (e.target.type === 'checkbox' || e.target.type === 'radio' || e.target.classList.contains('person-select')) {
                calculateBudget();
                checkFormValidity();
            }
        });

        categoriesContainer.addEventListener('input', (e) => {
            if (e.target.type === 'number') {
                const input = e.target;
                const checkbox = input.closest('.flex.items-center.justify-between').querySelector('input[type="checkbox"]');
                if (checkbox) {
                    checkbox.checked = parseFloat(input.value) > 0;
                }
                calculateBudget();
            }
        });

        eventsList.addEventListener('change', (e) => {
            if (e.target.type === 'checkbox') {
                calculateBudget();
            }
        });


        evaluateButton.addEventListener('click', () => {
            evaluationSection.style.display = 'block';
            document.querySelectorAll('.hidden-item').forEach(el => el.style.display = 'inline');
            document.querySelectorAll('.explanation-text').forEach(el => el.style.display = 'block');
            evaluateButton.style.display = 'none';
        });

        summaryToggle.addEventListener('click', () => {
            detailsSection.classList.toggle('open');
            const arrow = summaryToggle.querySelector('span');
            if (detailsSection.classList.contains('open')) {
                arrow.style.transform = 'rotate(180deg)';
            } else {
                arrow.style.transform = 'rotate(0deg)';
            }
        });

        eventsToggle.addEventListener('click', () => {
            eventsSection.classList.toggle('open');
            const arrow = eventsToggle.querySelector('span');
            if (eventsSection.classList.contains('open')) {
                arrow.style.transform = 'rotate(180deg)';
            } else {
                arrow.style.transform = 'rotate(0deg)';
            }
        });

        rollEventsButton.addEventListener('click', rollEvents);

        // Inicializace aplikace
        document.addEventListener('DOMContentLoaded', () => {
            loadIncomes();
            renderCategories();
            renderRandomEvents();
            calculateBudget();
            checkFormValidity();
        });
    </script>
</body>
</html>
